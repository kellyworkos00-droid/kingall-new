generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  ACCOUNTANT
  SALES
  STOREKEEPER
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum TransactionType {
  SALE
  PURCHASE
  PAYMENT
  RECEIPT
  JOURNAL
  ADJUSTMENT
}

enum PaymentMethod {
  CASH
  BANK
  MOBILE_MONEY
  CREDIT
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(SALES)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  salesOrders    SalesOrder[]
  purchaseOrders PurchaseOrder[]
  journalEntries JournalEntry[]
  stockMovements StockMovement[]
  activityLogs   ActivityLog[]

  @@index([email])
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  name        String
  description String?
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  costPrice   Decimal  @db.Decimal(10, 2)
  sellingPrice Decimal @db.Decimal(10, 2)
  reorderLevel Int     @default(10)
  barcode     String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stocks         Stock[]
  salesOrderItems    SalesOrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  stockMovements     StockMovement[]

  @@index([sku])
  @@index([categoryId])
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String   @unique
  location  String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stocks              Stock[]
  stockMovementsFrom  StockMovement[] @relation("FromWarehouse")
  stockMovementsTo    StockMovement[] @relation("ToWarehouse")
}

model Stock {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  quantity    Int      @default(0)
  updatedAt   DateTime @updatedAt

  @@unique([productId, warehouseId])
  @@index([productId])
  @@index([warehouseId])
}

model StockMovement {
  id              String            @id @default(uuid())
  productId       String
  product         Product           @relation(fields: [productId], references: [id])
  fromWarehouseId String?
  fromWarehouse   Warehouse?        @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouseId   String?
  toWarehouse     Warehouse?        @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
  type            StockMovementType
  quantity        Int
  notes           String?
  userId          String
  user            User              @relation(fields: [userId], references: [id])
  createdAt       DateTime          @default(now())

  @@index([productId])
  @@index([createdAt])
}

model Customer {
  id           String   @id @default(uuid())
  name         String
  email        String?
  phone        String?
  address      String?
  creditLimit  Decimal  @default(0) @db.Decimal(10, 2)
  balance      Decimal  @default(0) @db.Decimal(10, 2)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  salesOrders SalesOrder[]

  @@index([email])
  @@index([phone])
}

model Supplier {
  id             String   @id @default(uuid())
  name           String
  email          String?
  phone          String?
  address        String?
  balance        Decimal  @default(0) @db.Decimal(10, 2)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  purchaseOrders PurchaseOrder[]

  @@index([email])
  @@index([phone])
}

model SalesOrder {
  id             String        @id @default(uuid())
  orderNumber    String        @unique
  customerId     String
  customer       Customer      @relation(fields: [customerId], references: [id])
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  orderDate      DateTime      @default(now())
  totalAmount    Decimal       @db.Decimal(10, 2)
  discount       Decimal       @default(0) @db.Decimal(10, 2)
  tax            Decimal       @default(0) @db.Decimal(10, 2)
  grandTotal     Decimal       @db.Decimal(10, 2)
  paidAmount     Decimal       @default(0) @db.Decimal(10, 2)
  balance        Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @default(CASH)
  status         String        @default("completed")
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  items SalesOrderItem[]

  @@index([orderNumber])
  @@index([customerId])
  @@index([orderDate])
}

model SalesOrderItem {
  id           String     @id @default(uuid())
  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  quantity     Int
  unitPrice    Decimal    @db.Decimal(10, 2)
  total        Decimal    @db.Decimal(10, 2)

  @@index([salesOrderId])
  @@index([productId])
}

model PurchaseOrder {
  id            String   @id @default(uuid())
  orderNumber   String   @unique
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  orderDate     DateTime @default(now())
  totalAmount   Decimal  @db.Decimal(10, 2)
  discount      Decimal  @default(0) @db.Decimal(10, 2)
  tax           Decimal  @default(0) @db.Decimal(10, 2)
  grandTotal    Decimal  @db.Decimal(10, 2)
  paidAmount    Decimal  @default(0) @db.Decimal(10, 2)
  balance       Decimal  @db.Decimal(10, 2)
  status        String   @default("pending")
  notes         String?
  receivedDate  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items PurchaseOrderItem[]

  @@index([orderNumber])
  @@index([supplierId])
  @@index([orderDate])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Int
  unitPrice       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)

  @@index([purchaseOrderId])
  @@index([productId])
}

model Account {
  id          String      @id @default(uuid())
  code        String      @unique
  name        String
  type        AccountType
  parentId    String?
  parent      Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountHierarchy")
  balance     Decimal     @default(0) @db.Decimal(12, 2)
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  journalEntryLines JournalEntryLine[]

  @@index([code])
  @@index([type])
}

model JournalEntry {
  id          String   @id @default(uuid())
  entryNumber String   @unique
  date        DateTime @default(now())
  description String
  type        TransactionType
  referenceId String?
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lines JournalEntryLine[]

  @@index([entryNumber])
  @@index([date])
  @@index([type])
}

model JournalEntryLine {
  id             String       @id @default(uuid())
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  accountId      String
  account        Account      @relation(fields: [accountId], references: [id])
  debit          Decimal      @default(0) @db.Decimal(12, 2)
  credit         Decimal      @default(0) @db.Decimal(12, 2)
  description    String?

  @@index([journalEntryId])
  @@index([accountId])
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([entity])
}
